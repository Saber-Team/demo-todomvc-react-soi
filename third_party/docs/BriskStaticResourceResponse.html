<!DOCTYPE html>

<html>
<head>
  <title>BriskStaticResourceResponse.php</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="BriskDomProxy.html">
                  BriskDomProxy.php
                </a>
              
                
                <a class="source" href="BriskSafeHTML.html">
                  BriskSafeHTML.php
                </a>
              
                
                <a class="source" href="BriskSafeHTMLProducerInterface.html">
                  BriskSafeHTMLProducerInterface.php
                </a>
              
                
                <a class="source" href="BriskPagelet.html">
                  BriskPagelet.php
                </a>
              
                
                <a class="source" href="BriskPageletInterface.html">
                  BriskPageletInterface.php
                </a>
              
                
                <a class="source" href="BriskWebPage.html">
                  BriskWebPage.php
                </a>
              
                
                <a class="source" href="BriskWebPageInterface.html">
                  BriskWebPageInterface.php
                </a>
              
                
                <a class="source" href="BriskResources.html">
                  BriskResources.php
                </a>
              
                
                <a class="source" href="BriskResourcesOnDisk.html">
                  BriskResourcesOnDisk.php
                </a>
              
                
                <a class="source" href="BriskSantaResources.html">
                  BriskSantaResources.php
                </a>
              
                
                <a class="source" href="BriskAjaxResponse.html">
                  BriskAjaxResponse.php
                </a>
              
                
                <a class="source" href="BriskStaticResourceResponse.html">
                  BriskStaticResourceResponse.php
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>BriskStaticResourceResponse.php</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-meta">&lt;?php</span>

<span class="hljs-comment">/**
 * Tracks and resolves dependencies the page declares with
 * @{function:require_static}, and then builds appropriate HTML or
 * Ajax responses.
 * <span class="hljs-doctag">@file</span>
 * <span class="hljs-doctag">@email</span> zmike86<span class="hljs-doctag">@gmail</span>.com
 */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BriskStaticResourceResponse</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>动态设置cdn</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">protected</span> $cdn = <span class="hljs-string">''</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>默认打印全部资源表</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">protected</span> $printType = MAP_ALL;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>收集所有打印的外链资源唯一路径</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">protected</span> $symbols = <span class="hljs-keyword">array</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>记录打印的内联资源唯一id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">protected</span> $inlined = <span class="hljs-keyword">array</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>是否需要对收集的资源进行解析</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">protected</span> $needsResolve = <span class="hljs-keyword">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>命名空间划分,记录外链引用的资源</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">protected</span> $packaged;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>记录一些元数据</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">protected</span> $metadata = <span class="hljs-keyword">array</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>页面初始化需要的行为</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">protected</span> $behaviors = <span class="hljs-keyword">array</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>记录是否被渲染过</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">protected</span> $hasRendered = <span class="hljs-keyword">array</span>();

  <span class="hljs-keyword">protected</span> $postprocessorKey;

  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span> </span>{}

  <span class="hljs-keyword">final</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addMetadata</span><span class="hljs-params">($metadata)</span> </span>{
    $id = count(<span class="hljs-keyword">$this</span>-&gt;metadata);
    <span class="hljs-keyword">$this</span>-&gt;metadata[$id] = $metadata;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;
  }

  <span class="hljs-keyword">final</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getMetadata</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;metadata;
  }

  <span class="hljs-keyword">final</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setPostprocessorKey</span><span class="hljs-params">($postprocessor_key)</span> </span>{
    <span class="hljs-keyword">$this</span>-&gt;postprocessorKey = $postprocessor_key;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;
  }

  <span class="hljs-keyword">final</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPostprocessorKey</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;postprocessorKey;
  }

  <span class="hljs-keyword">final</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setCDN</span><span class="hljs-params">($cdn)</span> </span>{
    <span class="hljs-keyword">$this</span>-&gt;cdn = $cdn;
  }

  <span class="hljs-keyword">final</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getCDN</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;cdn;
  }

  <span class="hljs-keyword">final</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setPrintType</span><span class="hljs-params">($type)</span> </span>{
    <span class="hljs-keyword">$this</span>-&gt;printType = $type;
  }

  <span class="hljs-keyword">final</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPrintType</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;printType;
  }

  <span class="hljs-comment">/**
   * todo
   * Register a behavior for initialization.
   *
   * <span class="hljs-doctag">NOTE:</span> If `$config` is empty, a behavior will execute only once even if it
   * is initialized multiple times. If `$config` is nonempty, the behavior will
   * be invoked once for each configuration.
   */</span>
  <span class="hljs-keyword">final</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initBehavior</span><span class="hljs-params">($behavior, array $config = array<span class="hljs-params">()</span>, $source_name = null)</span> </span>{
    <span class="hljs-keyword">$this</span>-&gt;requireResource($behavior, $source_name);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-keyword">$this</span>-&gt;behaviors[$behavior])) {
      <span class="hljs-keyword">$this</span>-&gt;behaviors[$behavior] = <span class="hljs-keyword">array</span>();
    }
    <span class="hljs-keyword">if</span> ($config) {
      <span class="hljs-keyword">$this</span>-&gt;behaviors[$behavior][] = $config;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;
  }

  <span class="hljs-keyword">final</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getBehavior</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;behaviors;
  }

  <span class="hljs-comment">/**
   * 根据资源名获取线上路径
   * <span class="hljs-doctag">@param</span> BriskResourceMap $map
   * <span class="hljs-doctag">@param</span> $name
   * <span class="hljs-doctag">@return</span> string
   */</span>
  <span class="hljs-keyword">final</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getURI</span><span class="hljs-params">(BriskResourceMap $map, $name)</span> </span>{
    $uri = $map-&gt;getURIForName($name);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>If we have a postprocessor selected, add it to the URI.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $postprocessor_key = <span class="hljs-keyword">$this</span>-&gt;getPostprocessorKey();
    <span class="hljs-keyword">if</span> ($postprocessor_key) {
      $uri = preg_replace(<span class="hljs-string">'@^/res/@'</span>, <span class="hljs-string">'/res/'</span> . $postprocessor_key . <span class="hljs-string">'X/'</span>, $uri);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;cdn . $uri;
  }

  <span class="hljs-comment">/**
   * 记录请求依赖的外链资源
   * <span class="hljs-doctag">@param</span> string $name 工程目录资源路径
   * <span class="hljs-doctag">@param</span> string $source_name 空间
   * <span class="hljs-doctag">@return</span> mixed $this
   * <span class="hljs-doctag">@throws</span> Exception
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">requireResource</span><span class="hljs-params">($name, $source_name)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>首先确认资源表存在</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $map = BriskResourceMap::getNamedInstance($source_name);
    $symbol = $map-&gt;getNameMap()[$name];

    <span class="hljs-keyword">if</span> ($symbol === <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">Exception</span>(pht(
        <span class="hljs-string">'No resource with name "%s" exists in source "%s"!'</span>,
        $name,
        $source_name
      ));
    }

    <span class="hljs-keyword">if</span> (!array_key_exists($source_name, <span class="hljs-keyword">$this</span>-&gt;symbols)) {
      <span class="hljs-keyword">$this</span>-&gt;symbols[$source_name] = <span class="hljs-keyword">array</span>();
    }

    $symbols = <span class="hljs-keyword">$this</span>-&gt;symbols[$source_name];
    $resource_type = $map-&gt;getResourceTypeForName($name);</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>之前渲染过,不区分外链还是内联</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (array_search($name, $symbols, <span class="hljs-keyword">true</span>) &gt; <span class="hljs-number">-1</span> ||
      <span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;inlined[$source_name][$resource_type][$name])) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;
    }

    <span class="hljs-keyword">$this</span>-&gt;symbols[$source_name][] = $name;
    <span class="hljs-keyword">$this</span>-&gt;needsResolve = <span class="hljs-keyword">true</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;
  }

  <span class="hljs-comment">/**
   * 资源内联
   * <span class="hljs-doctag">@param</span> string $name 资源在工程目录的路径
   * <span class="hljs-doctag">@param</span> string $source_name 项目空间
   * <span class="hljs-doctag">@return</span> PhutilSafeHTML|string
   * <span class="hljs-doctag">@throws</span> Exception
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">inlineResource</span><span class="hljs-params">($name, $source_name)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>首先确认资源存在</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $map = BriskResourceMap::getNamedInstance($source_name);
    $symbol = $map-&gt;getNameMap()[$name];
    <span class="hljs-keyword">if</span> ($symbol === <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">Exception</span>(pht(
        <span class="hljs-string">'No resource with name "%s" exists in source "%s"!'</span>,
        $name,
        $source_name
      ));
    }

    $resource_type = $map-&gt;getResourceTypeForName($name);</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>之前已经内联渲染过</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;inlined[$source_name][$resource_type][$name])) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>立即渲染,不优化输出位置</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $fileContent = $map-&gt;getResourceDataForName($name, $source_name);
    <span class="hljs-keyword">$this</span>-&gt;inlined[$source_name][$resource_type][$name] = $fileContent;
    <span class="hljs-keyword">if</span> ($resource_type === <span class="hljs-string">'js'</span>) {
      <span class="hljs-keyword">return</span> BriskUtils::renderInlineScript($fileContent);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ($resource_type === <span class="hljs-string">'css'</span>) {
      <span class="hljs-keyword">return</span> BriskUtils::renderInlineStyle($fileContent);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
  }

  <span class="hljs-comment">/**
   * 将图片内联为dataUri的方式
   * <span class="hljs-doctag">@param</span> $name
   * <span class="hljs-doctag">@param</span> $source_name
   * <span class="hljs-doctag">@return</span> mixed
   * <span class="hljs-doctag">@throws</span> Exception
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generateDataURI</span><span class="hljs-params">($name, $source_name = <span class="hljs-string">'brisk'</span>)</span> </span>{
    $map = BriskResourceMap::getNamedInstance($source_name);
    $symbol = $map-&gt;getNameMap()[$name];
    <span class="hljs-keyword">if</span> ($symbol === <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">Exception</span>(pht(
        <span class="hljs-string">'No resource with name "%s" exists in source "%s"!'</span>,
        $name,
        $source_name
      ));
    }

    <span class="hljs-keyword">return</span> $map-&gt;generateDataURI($name);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>单独渲染一个外链资源</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">renderSingleResource</span><span class="hljs-params">($name, $source_name)</span> </span>{
    $map = BriskResourceMap::getNamedInstance($source_name);
    $symbol = $map-&gt;getNameMap()[$name];
    <span class="hljs-keyword">if</span> ($symbol === <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">Exception</span>(pht(
        <span class="hljs-string">'No resource with name "%s" exists in source "%s"!'</span>,
        $name,
        $source_name
      ));
    }
    $packaged = $map-&gt;getPackagedNamesForNames(<span class="hljs-keyword">array</span>($name));
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;renderPackagedResources($map, $packaged);
  }

  <span class="hljs-comment">/**
   * 渲染输出一种资源类型的html片段
   * <span class="hljs-doctag">@param</span> string $type 资源类型
   * <span class="hljs-doctag">@return</span> PhutilSafeHTML
   * <span class="hljs-doctag">@throws</span> Exception
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">renderResourcesOfType</span><span class="hljs-params">($type)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>更新$this-&gt;packaged</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">$this</span>-&gt;resolveResources();
    $result = <span class="hljs-keyword">array</span>();

    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">$this</span>-&gt;packaged <span class="hljs-keyword">as</span> $source_name =&gt; $resource_names) {
      $map = BriskResourceMap::getNamedInstance($source_name);
      $resources_of_type = <span class="hljs-keyword">array</span>();
      <span class="hljs-keyword">foreach</span> ($resource_names <span class="hljs-keyword">as</span> $resource_name) {
        $resource_type = $map-&gt;getResourceTypeForName($resource_name);
        <span class="hljs-keyword">if</span> ($resource_type == $type) {
          $resources_of_type[] = $resource_name;
        }
      }

      $result[] = <span class="hljs-keyword">$this</span>-&gt;renderPackagedResources($map, $resources_of_type);
    }

    <span class="hljs-keyword">if</span> ($type === <span class="hljs-string">'js'</span>) {
      <span class="hljs-keyword">$this</span>-&gt;printResourceMap($result);</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>todo modux插入到最前面</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      $name = $map-&gt;getSymbolMap()[<span class="hljs-string">'js'</span>][<span class="hljs-string">'modux'</span>][<span class="hljs-string">'path'</span>];
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;hasRendered[$name])) {
        array_unshift($result, <span class="hljs-keyword">$this</span>-&gt;renderResource($map, $name));
      }
    }

    <span class="hljs-keyword">return</span> phutil_implode_html(<span class="hljs-string">''</span>, $result);
  }

  <span class="hljs-comment">/**
   * 更新$this-&gt;packaged, $this-&gt;needsResolve标示false
   * <span class="hljs-doctag">@return</span> $this
   * <span class="hljs-doctag">@throws</span> Exception
   */</span>
  <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolveResources</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;needsResolve) {
      <span class="hljs-keyword">$this</span>-&gt;packaged = <span class="hljs-keyword">array</span>();
      <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">$this</span>-&gt;symbols <span class="hljs-keyword">as</span> $source_name =&gt; $names) {
        $map = BriskResourceMap::getNamedInstance($source_name);
        $packaged = $map-&gt;getPackagedNamesForNames($names);
        <span class="hljs-keyword">$this</span>-&gt;packaged[$source_name] = $packaged;
      }
      <span class="hljs-keyword">$this</span>-&gt;needsResolve = <span class="hljs-keyword">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;
  }

  <span class="hljs-comment">/**
   * 渲染全部需要的资源
   * <span class="hljs-doctag">@param</span> BriskResourceMap $map
   * <span class="hljs-doctag">@param</span> array $resources
   * <span class="hljs-doctag">@return</span> array
   * <span class="hljs-doctag">@throws</span> Exception
   */</span>
  <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">renderPackagedResources</span><span class="hljs-params">(BriskResourceMap $map, array $resources)</span> </span>{
    $output = <span class="hljs-keyword">array</span>();
    <span class="hljs-keyword">foreach</span> ($resources <span class="hljs-keyword">as</span> $name) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;hasRendered[$name])) {
        <span class="hljs-keyword">continue</span>;
      }
      <span class="hljs-keyword">$this</span>-&gt;hasRendered[$name] = <span class="hljs-keyword">true</span>;
      $output[] = <span class="hljs-keyword">$this</span>-&gt;renderResource($map, $name);
    }
    <span class="hljs-keyword">return</span> $output;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>渲染单个资源</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">renderResource</span><span class="hljs-params">(BriskResourceMap $map, $name)</span> </span>{
    <span class="hljs-keyword">if</span> ($map-&gt;isPackageResource($name)) {
      $package_info = $map-&gt;getPackageMap()[$name];
      $symbol = implode(<span class="hljs-string">'|'</span>, $package_info[<span class="hljs-string">'has'</span>]);
    } <span class="hljs-keyword">else</span> {
      $symbol = $map-&gt;getNameMap()[$name];
    }

    $uri = <span class="hljs-keyword">$this</span>-&gt;getURI($map, $name);
    $type = $map-&gt;getResourceTypeForName($name);</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <pre><code>   $multimeter = MultimeterControl::getInstance();
   <span class="hljs-keyword">if</span> ($multimeter) {
       $event_type = MultimeterEvent::TYPE_STATIC_RESOURCE;
       $multimeter-&gt;newEvent($event_type, <span class="hljs-string">'rsrc.'</span>.$name, <span class="hljs-number">1</span>);
   }
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">switch</span> ($type) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'css'</span>:
        <span class="hljs-keyword">return</span> phutil_tag(
          <span class="hljs-string">'link'</span>,
          <span class="hljs-keyword">array</span>(
            <span class="hljs-string">'rel'</span>   =&gt; <span class="hljs-string">'stylesheet'</span>,
            <span class="hljs-string">'type'</span>  =&gt; <span class="hljs-string">'text/css'</span>,
            <span class="hljs-string">'href'</span>  =&gt; $uri,
            <span class="hljs-string">'data-modux-hash'</span> =&gt; $symbol
          )
        );
      <span class="hljs-keyword">case</span> <span class="hljs-string">'js'</span>:
        <span class="hljs-keyword">return</span> phutil_tag(
          <span class="hljs-string">'script'</span>,
          <span class="hljs-keyword">array</span>(
            <span class="hljs-string">'type'</span>  =&gt; <span class="hljs-string">'text/javascript'</span>,
            <span class="hljs-string">'src'</span>   =&gt; $uri,
            <span class="hljs-string">'data-modux-hash'</span> =&gt; $symbol
          )
        );
    }

    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">Exception</span>(pht(
      <span class="hljs-string">'Unable to render resource "%s", which has unknown type "%s".'</span>,
      $name,
      $type
    ));
  }

  <span class="hljs-comment">/**
   * 输出打印资源表信息
   * <span class="hljs-doctag">@param</span> array $result
   * <span class="hljs-doctag">@throws</span> Exception
   */</span>
  <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printResourceMap</span><span class="hljs-params">(&amp;$result)</span> </span>{
    $res = <span class="hljs-keyword">array</span>(
      <span class="hljs-string">'resourceMap'</span> =&gt; <span class="hljs-keyword">array</span>(
        <span class="hljs-string">'js'</span> =&gt; <span class="hljs-keyword">array</span>(),
        <span class="hljs-string">'css'</span> =&gt; <span class="hljs-keyword">array</span>()
      )
    );

    <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">$this</span>-&gt;getPrintType()) {
      <span class="hljs-keyword">case</span> MAP_ALL:
        <span class="hljs-keyword">$this</span>-&gt;buildAllRes($res);
        $json = json_encode($res[<span class="hljs-string">'resourceMap'</span>]);
        $code = BriskUtils::renderInlineScript(
          <span class="hljs-string">'if ("undefined" !== typeof require) {require.setResourceMap('</span>
          . $json . <span class="hljs-string">')}'</span>
        );
        array_unshift($result, $code);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> MAP_ASYNC:
        <span class="hljs-keyword">$this</span>-&gt;buildAsyncRes($res);
        $json = json_encode($res[<span class="hljs-string">'resourceMap'</span>]);
        $code = BriskUtils::renderInlineScript(
          <span class="hljs-string">'if ("undefined" !== typeof require) {require.setResourceMap('</span>
          . $json . <span class="hljs-string">')}'</span>
        );
        array_unshift($result, $code);
        <span class="hljs-keyword">break</span>;
    }
  }

  <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildAllRes</span><span class="hljs-params">(&amp;$res)</span> </span>{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">$this</span>-&gt;packaged <span class="hljs-keyword">as</span> $source_name =&gt; $resource_names) {
      $map = BriskResourceMap::getNamedInstance($source_name);</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>记录到打印的资源表</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      $symbolMap = $map-&gt;getSymbolMap();
      <span class="hljs-keyword">foreach</span> ($symbolMap[<span class="hljs-string">'js'</span>] <span class="hljs-keyword">as</span> $symbol =&gt; $js) {
        <span class="hljs-keyword">unset</span>($js[<span class="hljs-string">'path'</span>]);
        <span class="hljs-keyword">unset</span>($js[<span class="hljs-string">'within'</span>]);
        $js[<span class="hljs-string">'uri'</span>] = <span class="hljs-keyword">self</span>::getCDN() . $js[<span class="hljs-string">'uri'</span>];
      }

      <span class="hljs-keyword">foreach</span> ($symbolMap[<span class="hljs-string">'css'</span>] <span class="hljs-keyword">as</span> $symbol =&gt; $css) {
        <span class="hljs-keyword">unset</span>($css[<span class="hljs-string">'path'</span>]);
        <span class="hljs-keyword">unset</span>($css[<span class="hljs-string">'within'</span>]);
        $css[<span class="hljs-string">'uri'</span>] = <span class="hljs-keyword">self</span>::getCDN() . $css[<span class="hljs-string">'uri'</span>];
      }

      $res[<span class="hljs-string">'resourceMap'</span>][<span class="hljs-string">'js'</span>] = array_merge(
        $res[<span class="hljs-string">'resourceMap'</span>][<span class="hljs-string">'js'</span>],
        $symbolMap[<span class="hljs-string">'js'</span>]
      );
      $res[<span class="hljs-string">'resourceMap'</span>][<span class="hljs-string">'css'</span>] = array_merge(
        $res[<span class="hljs-string">'resourceMap'</span>][<span class="hljs-string">'css'</span>],
        $symbolMap[<span class="hljs-string">'css'</span>]
      );
    }
  }

  <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildAsyncRes</span><span class="hljs-params">(&amp;$res)</span> </span>{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">$this</span>-&gt;packaged <span class="hljs-keyword">as</span> $source_name =&gt; $resource_names) {
      $map = BriskResourceMap::getNamedInstance($source_name);</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>记录到打印的资源表</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      $symbolMap = $map-&gt;getSymbolMap();
      <span class="hljs-keyword">foreach</span> ($symbolMap[<span class="hljs-string">'js'</span>] <span class="hljs-keyword">as</span> $symbol =&gt; $js) {
        <span class="hljs-keyword">foreach</span> ($js[<span class="hljs-string">'asyncLoaded'</span>] <span class="hljs-keyword">as</span> $required_symbol) {
          <span class="hljs-keyword">$this</span>-&gt;addJsRes($required_symbol, $symbolMap, $res);
        }
      }
    }
  }

  <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addJsRes</span><span class="hljs-params">($required_symbol, $map, &amp;$res)</span> </span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>($res[<span class="hljs-string">'resourceMap'</span>][<span class="hljs-string">'js'</span>][$required_symbol])) {
      $required_js = $map[<span class="hljs-string">'js'</span>][$required_symbol];
      $res[<span class="hljs-string">'resourceMap'</span>][<span class="hljs-string">'js'</span>][$required_symbol] = <span class="hljs-keyword">array</span>(
        <span class="hljs-string">'type'</span> =&gt; <span class="hljs-string">'js'</span>,
        <span class="hljs-string">'uri'</span> =&gt; <span class="hljs-keyword">self</span>::getCDN() . $required_js[<span class="hljs-string">'uri'</span>],
        <span class="hljs-string">'deps'</span> =&gt; $required_js[<span class="hljs-string">'deps'</span>],
        <span class="hljs-string">'css'</span> =&gt; $required_js[<span class="hljs-string">'css'</span>]
      );</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>加载$required_js的依赖</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">foreach</span> ($required_js[<span class="hljs-string">'css'</span>] <span class="hljs-keyword">as</span> $required_css_symbol) {
        <span class="hljs-keyword">$this</span>-&gt;addCssRes($required_css_symbol, $map, $res);
      }
      <span class="hljs-keyword">foreach</span> ($required_js[<span class="hljs-string">'asyncLoaded'</span>] <span class="hljs-keyword">as</span> $required_js_symbol) {
        <span class="hljs-keyword">$this</span>-&gt;addJsRes($required_js_symbol, $map, $res);
      }
    }
  }

  <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addCssRes</span><span class="hljs-params">($required_symbol, $map, &amp;$res)</span> </span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>($res[<span class="hljs-string">'resourceMap'</span>][<span class="hljs-string">'css'</span>][$required_symbol])) {
      $required_css = $map[<span class="hljs-string">'css'</span>][$required_symbol];
      $res[<span class="hljs-string">'resourceMap'</span>][<span class="hljs-string">'css'</span>][$required_symbol] = <span class="hljs-keyword">array</span>(
        <span class="hljs-string">'type'</span> =&gt; <span class="hljs-string">'css'</span>,
        <span class="hljs-string">'uri'</span> =&gt; <span class="hljs-keyword">self</span>::getCDN() . $required_css[<span class="hljs-string">'uri'</span>],
        <span class="hljs-string">'css'</span> =&gt; $required_css[<span class="hljs-string">'css'</span>]
      );</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>加载$required_css的依赖</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">foreach</span> ($required_css[<span class="hljs-string">'css'</span>] <span class="hljs-keyword">as</span> $required_css_symbol) {
        <span class="hljs-keyword">$this</span>-&gt;addCssRes($required_css_symbol, $map, $res);
      }
    }
  }
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
